---
# This playbook configures all systems
# for consumption of SAP software
- name: Prepare for generic SAP Install
  hosts: gcp_awx_group_hana, gcp_awx_group_s4
  become: true

  vars:
    reg_activation_key: "{{ sap_rhsm_activationkey }}"
    reg_organization_id: "{{ sap_rhsm_org_id }}"
    reg_osrelease: 8.4
    repositories:
      - rhel-8-for-x86_64-baseos-e4s-rpms
      - rhel-8-for-x86_64-appstream-e4s-rpms
      - rhel-8-for-x86_64-sap-solutions-e4s-rpms
      - rhel-8-for-x86_64-sap-netweaver-e4s-rpms
      - rhel-8-for-x86_64-highavailability-e4s-rpms

  tasks:
    - name: Ensure Correct subscription and repositories
      include_role:
        name: mk-ansible-roles.subscribe_rhn

    - name: define storage_pool variable for storage setup
      set_fact:
         storage_pools: "{{ gcp_machines | selectattr('name', 'equalto', inventory_hostname) | sum(attribute='storage_pools', start=[]) }}"
         storage_skip_checks:
           - blivet_available
           - packages_installed

    - name: Configure disk2
      include_role:
        name: redhat.rhel_system_roles.storage

    - name: Configure generic SAP requirements
      include_role:
        name: community.sap_install.sap_general_preconfigure

- name: Prepare for generic SAP HANA Install
  hosts: gcp_awx_group_hana
  become: true
  roles:
               - community.sap_install.sap_hana_preconfigure


- name: Prepare for generic SAP Netweaver Install
  hosts: gcp_awx_group_s4
  become: true
  roles:
               - community.sap_install.sap_netweaver_preconfigure
